# Практика 1
## Макаров Михаил Максимович
## ББМО-02-23
Была создана ВМ с ОС Debian\

___
[Начало](#Начало)\
[rsyslog](#rsyslog)\
[Настройка сервера](#настройка-сервера)\
[Настройка клиента](#настройка-клиента)\
[Проверка логов на сервере](#проверка-логов-на-сервере)\
[LOKI](#loki)\
[Настройка клиента (promtail)](#настройка-клиента-(promtail))\
[Возвращаемся к серверу](#Возвращаемся-к-серверу)\
___

### Начало
Из под пользователя root: 
```bash
su root
```
Установили консольный менеджер файлов mc\
Отредактировали файл sudoers, добавив пользователю user права на sudo
```bash
mcedit /etc/sudoers
```
Выполнили обновление системы, установили пакеты, необходимые для дополнений VBox\
Установили сами дополнения VBox

| ![](images/Снимок%20экрана%202024-09-24%20224417.png) | 
|:--:| 
| *Выполненные команды* |

| ![](images/Снимок%20экрана%202024-09-24%20222856.png) |
|:--:|
| *Файл /etc/sudoers* |

Создали две связные копии из имеющийся виртуальной машины и настроили между ними сетевой мост

| ![](images/Снимок%20экрана%202024-09-24%20220626.png) |
|:--:|
| *2 новые ВМ* |

| ![](images/Снимок%20экрана%202024-09-24%20220653.png) |
|:--:|
| *ВМ server* |

| ![](images/Снимок%20экрана%202024-09-24%20220704.png) |
|:--:|
| *ВМ client* |
___
___
## rsyslog
### Настройка сервера
___
Переименовываем машину
|![](images/Снимок%20экрана%202024-09-24%20233110.png)|
|:--:|
|*server*|

|![](images/Снимок%20экрана%202024-09-24%20233402.png)|
|:--:|
|*Уставнока rsyslog*|

Запускаем rsyslog, включаем в автозапуск, проверяем
|![](images/Снимок%20экрана%202024-09-24%20234229.png)|
|:--:|
|*rsyslog*|

Задаём работу по udp с портом 514
|![](images/Снимок%20экрана%202024-09-24%20235530.png)|
|:--:|
|*Настройка порта*|

Прописываем правила
|![](images/Снимок%20экрана%202024-09-24%20234647.png)|
|:--:|
|*Правила*|

Проверяем работу, также проверили с помощью
```bash
sudo systemctl status rsyslog
```
|![](images/Снимок%20экрана%202024-09-24%20234905.png)|
|:--:|
|*Проверка*|

Итог:
- Установими hostname
- Запустили rsyslog
- Настроили rsyslog
- Проверили

|![](images/Снимок%20экрана%202024-09-24%20234955.png)|
|:--:|
|*Итог*|

___
___
### Настройка клиента
___
:::
- Устанавливаем rsyslog
- Изменяем имя машины
- запускаем, включаем автозапуск, проверяем
- Редактируем конфиг (all.conf - для всех логов)
```bash
mcedit /etc/rsyslog.d/all.conf
```
- Перезапускаем rsyslog
- Проверяем

|![](images/Снимок%20экрана%202024-09-25%20003711.png)|
|:--:|
|*Шаги*|

|![](images/Снимок%20экрана%202024-09-25%20003614.png)|
|:--:|
|*Конфиг*|

|![](images/Снимок%20экрана%202024-09-25%20003722.png)|
|:--:|
|*Проверка*|
___
___
### Проверка логов на сервере
___

Смотрим директорию
```bash
ls /var/log
```
Видим директорию client (hostname второй ВМ, с которой мы отправляем логи)\
Проверяем
```bash
ls /var/log/client
```

Видим полученные логи

|![](images/Снимок%20экрана%202024-09-25%20005028.png)|
|:--:|
|*Проверка логов на сервере*|

___
___
___
## LOKI
___

Устанавливаем пакеты git и wget

|![](images/Снимок%20экрана%202024-09-25%20011123.png)|
|:--:|
|*Установка пакетов*|

Получаем бинарники go

|![](images/Снимок%20экрана%202024-09-25%20011638.png)|
|:--:|
|*wget*|

Распаковываем и устанавливаем

|![](images/Снимок%20экрана%202024-09-25%20014441.png)|
|:--:|
|*go go go*|

Добавляем путь до go

|![](images/Снимок%20экрана%202024-09-25%20011728.png)|
|:--:|
|*/etc/profile*|

Проверяем go

|![](images/Снимок%20экрана%202024-09-25%20011751.png)|
|:--:|
|*Проверка*|

Добавляем разрешение работать по tcp и порту 3100

|![](images/Снимок%20экрана%202024-09-25%20011924.png)|
|:--:|
|*tcp*|

Получаем исходники loki и собираем

|![](images/Снимок%20экрана%202024-09-25%20012719.png)|
|:--:|
|*loki*|

Устанавливаем и запускаем для проверки

|![](images/Снимок%20экрана%202024-09-25%20013433.png)|
|:--:|
|*Копирование loki*|

Проверяем в браузере метрики

|![](images/Снимок%20экрана%202024-09-25%20013625.png)|
|:--:|
|*Проверка в firefox*|

Для работы в фоне, создаём пользователя и прописываем необходимые права

|![](images/Снимок%20экрана%202024-09-25%20013724.png)|
|:--:|
|*Пользователь loki*|

Создаём файл
```bash
/etc/systemd/system/loki.service
```
Заполняем необходимой инорфмацией

|![](images/Снимок%20экрана%202024-09-25%20013744.png)|
|:--:|
|*Файл loki.service*|

Добавляем loki в автозапуск и включаем

|![](images/Снимок%20экрана%202024-09-25%20013810.png)|
|:--:|
|*enable loki*|

Проверяем 
```bash
systemctl status loki
```

|![](images/Снимок%20экрана%202024-09-25%20013825.png)|
|:--:|
|*status loki*|

___
___
### Настройка клиента (promtail)
___

- Убиваем rsyslog, чтобы не мешал
- Устанавливаем wget и unzip
- Получаем promtail
- Устанавливаем, добавляем в качестве сервиса, прописываем правила, запускаем

|![](images/Снимок%20экрана%202024-09-25%20015810.png)|
|:--:|
|*get promtail*|

```bash
/etc/promtail/promtail.yaml
```

|![](images/Снимок%20экрана%202024-09-25%20015827.png)|
|:--:|
|*promtail.yaml*|

```bash
/etc/systemd/system/promtail.service
```

|![](images/Снимок%20экрана%202024-09-25%20015843.png)|
|:--:|
|*promtail.service*|

Проверяем 

|![](images/Снимок%20экрана%202024-09-25%20015859.png)|
|:--:|
|*status*|

Проверяем в браузере

|![](images/Снимок%20экрана%202024-09-25%20020020.png)|
|:--:|
|*Проверка сервиса в браузере*|

Настраиваем порт 9080 tcp

|![](images/Снимок%20экрана%202024-09-25%20020042.png)|
|:--:|
|*iptables*|

Добавляем необходимые файлы в конфигурационный файл 

|![](images/Снимок%20экрана%202024-09-25%20020441.png)|
|:--:|
|*promtail.yaml*|

Перезапускаем сервис promtail и возвращаемся в бразуер, видим, что наши параметры добавлены

|![](images/Снимок%20экрана%202024-09-25%20020635.png)|
|:--:|
|*Добавленные файлы отображаются в браузете*|

___
___
### Возвращаемся к серверу
___

Скачиваем grafana

```bash
wget https://dl.grafana.com/oss/release/grafana_11.2.0_amd64.deb
```

Устанавливаем 
```bash
sudo dpkg -i grafana_11.2.0_amd64.deb
```


|![](images/Снимок%20экрана%202024-09-25%20023726.png)|
|:--:|
|*Скачиваем*|

Настраиваем порт 3000

|![](images/Снимок%20экрана%202024-09-25%20024030.png)|
|:--:|
|*Порт 3000*|

Проверяем

|![](images/Снимок%20экрана%202024-09-25%20024110.png)|
|:--:|
|*grafana status*|

Открываем браузер, вводим логин/пароль по-умолчанию (admin/admin)\
Меняем пароль на свой, видим приветственное окно grafana

|![](images/Снимок%20экрана%202024-09-25%20024235.png)|
|:--:|
|*Окно grafana*|

Добавляем новый источник данных

|![](images/Снимок%20экрана%202024-09-25%20024422.png)|
|:--:|
|*Данные с Loki*|

Вводим, что необходимо

|![](images/Снимок%20экрана%202024-09-25%20024504.png)|
|:--:|
|*Данные*|

Нажимаем сохранить и проверить, получаем успешное сообщение

|![](images/Снимок%20экрана%202024-09-25%20024518.png)|
|:--:|
|*Успешное сообщение*|

Создаём новый DashBoard\
Выбираем добавленные данные

|![](images/Снимок%20экрана%202024-09-25%20024556.png)|
|:--:|
|*Выбор данных*|

Настраиваем, выбираем, например, выборка по filename и файл auth.log

|![](images/Снимок%20экрана%202024-09-25%20024825.png)|
|:--:|
|*Настройка DashBoard*|

Нажимаем Run query, т.к. из наших данных нельзя построить график - выбираем таблицу

|![](images/Снимок%20экрана%202024-09-25%20025018.png)|
|:--:|
|*Таблица*|

Сохраняем, получаем наш DashBoard на главной странице

|![](images/Снимок%20экрана%202024-09-25%20025048.png)|
|:--:|
|*DashBoard на главной странице*|

___
## Выполнил Макаров Михаил Максимович
## ББМО-02-23
___
___
___